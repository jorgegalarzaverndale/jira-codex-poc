name: Claude Code Auto-Fix from Jira

on:
  repository_dispatch:
    types: [jira-ai-fix]

permissions:
  contents: write
  pull-requests: write

jobs:
  claude-fix:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Extract Jira ticket info
        id: ticket
        run: |
          echo "title=${{ github.event.client_payload.title }}" >> $GITHUB_OUTPUT
          echo "key=${{ github.event.client_payload.key }}" >> $GITHUB_OUTPUT

      - name: Create branch
        run: |
          BRANCH="claude/fix-${{ steps.ticket.outputs.key }}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Run Claude Code to fix the issue
        run: |
          claude -p "Jira ticket ${{ steps.ticket.outputs.key }}: ${{ steps.ticket.outputs.title }}

          Description: ${{ github.event.client_payload.description }}

          Instructions:
          1. Read the file operations.md
          2. Find the wrong result described in the ticket
          3. Fix only that specific result
          4. Do not change anything else" \
            --allowedTools "Edit,Read,Write" \
            --dangerously-skip-permissions

      - name: Commit and push
        run: |
          git config user.name "claude-bot"
          git config user.email "claude-bot@users.noreply.github.com"
          git add -A
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "fix: ${{ steps.ticket.outputs.key }} - ${{ steps.ticket.outputs.title }}"
          git push origin "$BRANCH"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH }}
          title: "fix: ${{ steps.ticket.outputs.key }} - ${{ steps.ticket.outputs.title }}"
          body: |
            ## Automated fix by Claude Code

            **Jira ticket:** ${{ steps.ticket.outputs.key }}
            **Summary:** ${{ steps.ticket.outputs.title }}

            ---

            This PR was automatically generated by Claude Code in response to a Jira ticket.
            Please review the changes and merge if correct.
          reviewers: jorgegalarzaverndale
