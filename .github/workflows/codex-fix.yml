name: Codex Auto-Fix from Jira

on:
  repository_dispatch:
    types: [jira-ai-fix]

permissions:
  contents: write
  pull-requests: write

jobs:
  codex-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Jira ticket info
        id: ticket
        run: |
          echo "title=${{ github.event.client_payload.title }}" >> $GITHUB_OUTPUT
          echo "key=${{ github.event.client_payload.key }}" >> $GITHUB_OUTPUT
          echo '${{ github.event.client_payload.description }}' > /tmp/ticket_description.txt

      - name: Create branch
        run: |
          BRANCH="codex/fix-${{ steps.ticket.outputs.key }}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Run Codex to fix the issue
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            Jira ticket ${{ steps.ticket.outputs.key }}: ${{ steps.ticket.outputs.title }}

            Description:
            $(cat /tmp/ticket_description.txt)

            Instructions:
            1. Read the file operations.md
            2. Find the wrong result described in the ticket
            3. Fix only that specific result
            4. Do not change anything else
          codex-args: '["--full-auto"]'
          sandbox: "workspace-write"
          output-file: codex-output.md

      - name: Commit and push
        run: |
          git config user.name "codex-bot"
          git config user.email "codex-bot@users.noreply.github.com"
          git add -A
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "fix: ${{ steps.ticket.outputs.key }} - ${{ steps.ticket.outputs.title }}"
          git push origin "$BRANCH"

      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH }}
          title: "fix: ${{ steps.ticket.outputs.key }} - ${{ steps.ticket.outputs.title }}"
          body: |
            ## Automated fix by Codex

            **Jira ticket:** ${{ steps.ticket.outputs.key }}
            **Summary:** ${{ steps.ticket.outputs.title }}

            ---

            This PR was automatically generated by Codex in response to a Jira ticket.
            Please review the changes and merge if correct.
          reviewers: jorgegalarzaverndale
